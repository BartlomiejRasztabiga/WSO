- name: Tworzenie VM i provisioning
  hosts: local
  become: true
  vars_files:
    - ../vars/vm_config.yaml
  roles:
    - vm

  tasks:
    # - name: Wait for VM to connect to the network
    #   wait_for:
    #     timeout: 30
    #     path: /dev/null
    #   delegate_to: localhost
    #   loop: "{{ vms }}"
    #   loop_control:
    #     label: "{{ item.name }}"

    - name: Pobierz adres IP nowej VM
      shell: virsh domifaddr {{ item.name }} | grep -oP '(\d{1,3}\.){3}\d{1,3}' | head -n1
      register: vm_ip_result
      changed_when: false
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    # - name: Debug output of virsh domifaddr
    #   debug:
    #     msg: "virsh domifaddr output for {{ item.name }}: {{ vm_ip_result }}"
    #   loop: "{{ vms }}"
    #   loop_control:
    #     label: "{{ item.name }}"

    # - name: Debug registered vm_ip_result
    #   debug:
    #     var: vm_ip_result

    - name: Dodaj VM dynamicznie do inventory
      add_host:
        name: "{{ item.item.name }}"
        ansible_host: "{{ item.stdout }}"
        ansible_user: ubuntu
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        groups: dynamic_vms
      loop: "{{ vm_ip_result.results }}"
      when: item.stdout is defined

    - name: Dopisz dynamiczne VM do inventory/hosts
      blockinfile:
        path: "{{ playbook_dir }}/../inventory/hosts"
        marker: "# {mark} DYNAMIC INVENTORY FOR VM {{ item.item.name }}"
        block: |
          [dynamic_vms]
          {{ item.item.name }} ansible_host={{ item.stdout }} ansible_user=ubuntu ansible_ssh_common_args='-o StrictHostKeyChecking=no'
      loop: "{{ vm_ip_result.results }}"
      when: item.stdout is defined

- name: Provisioning VM przez SSH
  hosts: dynamic_vms
  become: true
  tasks:
    - name: Ping test
      ping:

    - name: Instalacja pakiet√≥w
      apt:
        name:
          - htop
          - curl
        state: present
        update_cache: yes