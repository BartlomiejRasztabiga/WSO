- name: Tworzenie VM i provisioning
  hosts: local
  become: true
  vars_files:
    - ../vars/vm_config.yaml
  roles:
    - vm

  tasks:
    - name: Pobierz adres IP nowej VM
      shell: virsh domifaddr {{ vm_name }} | grep -oP '(\d{1,3}\.){3}\d{1,3}' | head -n1
      register: vm_ip_result
      changed_when: false

    - name: Dodaj VM dynamicznie do inventory
      add_host:
        name: "{{ vm_name }}"
        ansible_host: "{{ vm_ip_result.stdout }}"
        ansible_user: ubuntu
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        groups: dynamic_vms
    
    - name: Dopisz dynamiczną VM do inventory/hosts
      blockinfile:
        path: "{{ playbook_dir }}/../inventory/hosts"
        marker: "# {mark} DYNAMIC INVENTORY FOR VM {{ vm_name }}"
        block: |
          [dynamic_vms]
          {{ vm_name }} ansible_host={{ vm_ip_result.stdout }} ansible_user=ubuntu ansible_ssh_common_args='-o StrictHostKeyChecking=no'



- name: Provisioning VM przez SSH
  hosts: dynamic_vms
  become: true
  tasks:
    - name: Ping test
      ping:

    - name: Instalacja pakietów
      apt:
        name:
          - htop
          - curl
        state: present
        update_cache: yes